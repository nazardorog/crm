pipeline {
    agent any

    parameters {
        extendedChoice(
                name: 'TEST_CLASSES_TO_RUN',
                type: 'PT_CHECKBOX',
                multiSelectDelimiter: ',',
                defaultValue: '',
                description: 'Оберіть класи тестів для запуску',
                value: '''
web.expedite.smoke.loadBoard.WES001_LoadCreateBol,
web.expedite.smoke.loadBoard.WES002_LoadCreateRateConfirmation,
web.expedite.smoke.loadBoard.WES003_LoadCreatePod,
web.expedite.smoke.loadBoard.WES004_LoadCreateOther,
web.expedite.smoke.loadBoard.WES005_ValidateRateBrokerOwner'''
        )
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'master',
                        credentialsId: 'your-git-credentials-id',
                        url: 'https://github.com/nazardorog/crm.git'
            }
        }

        stage('Run selected tests') {
            steps {
                script {
                    if (!params.TEST_CLASSES_TO_RUN?.trim()) {
                        error "Оберіть хоча б один тест для запуску"
                    }

                    def tests = params.TEST_CLASSES_TO_RUN.split(',')*.trim()
                    def testList = tests.join(",")

                    echo "Запускаємо тести: ${testList}"

                    sh """
                        docker run --rm \\
                            --network shared_network \\
                            -v "\${PWD}":/app \\
                            -w /app \\
                            -e RUN_ENV=jenkins \\
                            maven:3.8-openjdk-17 \\
                            mvn clean test -Dtest="${testList}" -Dsurefire.rerunFailingTestsCount=1
                    """
                }
            }
        }

        stage('Allure Report') {
            steps {
                allure([
                        reportBuildPolicy: 'ALWAYS',
                        results: [[path: 'target/allure-results']]
                ])
            }
        }
    }
}