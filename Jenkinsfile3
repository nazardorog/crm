pipeline {
    agent any

    parameters {
        booleanParam(
                name: 'ExpediteSmoke',
                defaultValue: false,
                description: 'üîπüîπüîπExpedite Smoke –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –≤—Å—ñ —Ç–µ—Å—Ç–∏üîπüîπüîπ'
        )
        booleanParam(
                name: 'WES001_LoadCreateBol',
                defaultValue: false,
                description: '–°—Ç–≤–æ—Ä–µ–Ω–Ω—è New Load –∑ —Ç–∏–ø–æ–º —Ñ–∞–π–ª–∞ Pod'
        )
        booleanParam(
                name: 'WES002_LoadCreateRateConfirmation',
                defaultValue: false,
                description: '–°–æ–∑–¥–∞–Ω–∏–µ New Load —Å —Ç–∏–ø–æ–º —Ñ–∞–π–ª–∞ Rate Confirmation'
        )
        booleanParam(
                name: 'WES003_LoadCreatePod',
                defaultValue: false,
                description: '–°–æ–∑–¥–∞–Ω–∏–µ New Load —Å —Ç–∏–ø–æ–º —Ñ–∞–π–ª–∞ Pod'
        )
        booleanParam(
                name: 'WES004_LoadCreateOther',
                defaultValue: false,
                description: '–°–æ–∑–¥–∞–Ω–∏–µ New Load —Å —Ç–∏–ø–æ–º —Ñ–∞–π–ª–∞ Other'
        )
        booleanParam(
                description: '–°–æ–∑–¥–∞–Ω–∏–µ New Load / –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π —Ä–µ–π—Ç–∞ –±—Ä–æ–∫–µ—Ä –∏ –¥—Ä–∞–π–≤–µ—Ä–∞',
                name: 'WES005_ValidateRateBrokerOwner',
                defaultValue: false
        )
        booleanParam(
                description: '–°–æ–∑–¥–∞–Ω–∏–µ New Load / –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π –¥–∞—Ç—ã –≤ –ü–£ –∏ –î–ï–õ',
                name: 'WES006_ValidateDateShipperReceiver',
                defaultValue: false
        )

        booleanParam(
                description: '–°–æ–∑–¥–∞–Ω–∏–µ New Load / –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ –ø–æ–¥—Å—á–µ—Ç–∞ plts / wght / pcs',
                name: 'WES007_ValidatePltWtPcs',
                defaultValue: false
        )
        booleanParam(
                description: '–°–æ–∑–¥–∞–Ω–∏–µ New Load / dispatch load / –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–∫–∞ –Ω–∞ –≥—Ä—É–∑ —á–µ—Ä–µ–∑ –ø–æ–ª–µ —Ç—Ä–∞–∫',
                name: 'WES008_DispatchAddTruckByTruck',
                defaultValue: false
        )
        booleanParam(
                description: '–°–æ–∑–¥–∞–Ω–∏–µ New Load / dispatch load / –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–∫–∞ –Ω–∞ –≥—Ä—É–∑ —á–µ—Ä–µ–∑ –ø–æ–ª–µ –∏–º—è –≤–æ–¥–∏—Ç–µ–ª—è',
                name: 'WES009_DispatchAddTruckByDriver',
                defaultValue: false
        )
        booleanParam(
                description: '–°–æ–∑–¥–∞–Ω–∏–µ New Load / dispatch load / –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–∫–∞ –Ω–∞ –≥—Ä—É–∑ —á–µ—Ä–µ–∑ –ø–æ–ª–µ —Ç–∏–º –¥—Ä–∞–π–≤–µ—Ä',
                name: 'WES010_DispatchAddTruckByTeamDriver',
                defaultValue: false
        )
        booleanParam(
                description: '–°–æ–∑–¥–∞–Ω–∏–µ New Load / dispatch load / assign user',
                name: 'WES011_DispatchAssignUser',
                defaultValue: false
        )
        booleanParam(
                description: '–°–æ–∑–¥–∞–Ω–∏–µ New Load / dispatch load / –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≥—Ä—É–∑–∞',
                name: 'WES012_DispatchCalculate',
                defaultValue: false
        )
        booleanParam(
                description: '–ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –≥—Ä—É–∑ —Å–æ–∑–¥–∞–ª—Å—è –≤–µ—Ä–Ω–æ, –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤—Å–µ —Ç–∏–ø—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤(–±–æ–ª —Ä–∞–π—Ç –∫–æ–Ω –∏ —Ç–¥)',
                name: 'WES013_FileOpenAll',
                defaultValue: false
        )
        booleanParam(
                description: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ì—Ä—É–∑–∞',
                name: 'WES014_LoadEdit',
                defaultValue: false
        )
        booleanParam(
                description: '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ 2–≥–æ —Ç—Ä–∞–∫–∞ –Ω–∞ –≥—Ä—É–∑',
                name: 'WES015_LoadAddSecondTruck',
                defaultValue: false
        )
        choice(
                name: 'MAX_PARALLEL_THREADS',
                choices: ['1', '2', '3', '4', '5'],
                description: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –æ–¥–Ω–æ—á–∞—Å–Ω–∏—Ö –ø–æ—Ç–æ–∫—ñ–≤ –¥–ª—è —Ç–µ—Å—Ç—ñ–≤'
        )
    }

    stages {

        stage('–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞') {

            steps {

                echo "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–∏–±—Ä–∞–Ω–∏—Ö —Ç–µ—Å—Ç—ñ–≤..."
                script {
                    sh '''
                        # –û—á–∏—â–µ–Ω–Ω—è workspace
                        rm -rf target/ allure-report allure-report.zip
                        mkdir -p target/allure-results

                        echo "‚úÖ Workspace –æ—á–∏—â–µ–Ω–æ"
                    '''

                    def selectedTests = []

                    if (params.ExpediteSmoke) {
                        echo "ExpediteSmoke —É–≤—ñ–º–∫–Ω–µ–Ω–æ. –®—É–∫–∞—î–º–æ –≤—Å—ñ —Ç–µ—Å—Ç–∏ —É src/test/java/web/expedite/smoke/loadBoard..."

                        def testFiles = sh(
                                script: "find src/test/java/web/expedite/smoke/loadBoard -name 'WES*.java' -exec basename {} .java \\;",
                                returnStdout: true
                        ).trim()

                        selectedTests = testFiles.split('\n')
                        echo "–ê–≤—Ç–æ–≤–∏–±—Ä–∞–Ω—ñ —Ç–µ—Å—Ç–∏: ${selectedTests.join(', ')}"
                    } else {
                        if (params.WES001_LoadCreateBol) selectedTests.add('WES001_LoadCreateBol')
                        if (params.WES002_LoadCreateRateConfirmation) selectedTests.add('WES002_LoadCreateRateConfirmation')
                        if (params.WES003_LoadCreatePod) selectedTests.add('WES003_LoadCreatePod')
                        if (params.WES004_LoadCreateOther) selectedTests.add('WES004_LoadCreateOther')
                        if (params.WES005_ValidateRateBrokerOwner) selectedTests.add('WES005_ValidateRateBrokerOwner')
                        if (params.WES006_ValidateDateShipperReceiver) selectedTests.add('WES006_ValidateDateShipperReceiver')
                        if (params.WES007_ValidatePltWtPcs) selectedTests.add('WES007_ValidatePltWtPcs')
                        if (params.WES008_DispatchAddTruckByTruck) selectedTests.add('WES008_DispatchAddTruckByTruck')
                        if (params.WES009_DispatchAddTruckByDriver) selectedTests.add('WES009_DispatchAddTruckByDriver')
                        if (params.WES010_DispatchAddTruckByTeamDriver) selectedTests.add('WES010_DispatchAddTruckByTeamDriver')
                        if (params.WES011_DispatchAssignUser) selectedTests.add('WES011_DispatchAssignUser')
                        if (params.WES012_DispatchCalculate) selectedTests.add('WES012_DispatchCalculate')
                        if (params.WES013_FileOpenAll) selectedTests.add('WES013_FileOpenAll')
                        if (params.WES014_LoadEdit) selectedTests.add('WES014_LoadEdit')
                        if (params.WES015_LoadAddSecondTruck) selectedTests.add('WES015_LoadAddSecondTruck')

                        if (selectedTests.isEmpty()) {
                            error("–ù–µ –≤–∏–±—Ä–∞–Ω–æ –∂–æ–¥–Ω–æ–≥–æ —Ç–µ—Å—Ç—É! –í–∏–±–µ—Ä—ñ—Ç—å —Ç–µ—Å—Ç–∏ –¥–ª—è –∑–∞–ø—É—Å–∫—É.")
                        }

                        echo "–í–∏–±—Ä–∞–Ω—ñ —Ç–µ—Å—Ç–∏: ${selectedTests.join(', ')}"
                    }

                    env.SELECTED_TESTS = selectedTests.join(',')
                }
            }
        }

        stage('–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç—ñ–≤') {
            steps {
                script {
                    def testsToRun = env.SELECTED_TESTS.split(',')
                    def maxThreads = params.MAX_PARALLEL_THREADS.toInteger()

                    echo "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç—ñ–≤ –∑ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—é –∫—ñ–ª—å–∫—ñ—Å—Ç—é –ø–æ—Ç–æ–∫—ñ–≤: ${maxThreads}"

                    // –Ø–∫—â–æ –ø–æ—Ç–æ–∫—ñ–≤ –±—ñ–ª—å—à–µ –Ω—ñ–∂ —Ç–µ—Å—Ç—ñ–≤, –∞–±–æ –ø–æ—Ç—ñ–∫ —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω - –∑–∞–ø—É—Å–∫–∞—î–º–æ –∑–≤–∏—á–∞–π–Ω–æ
                    if (maxThreads >= testsToRun.size() || maxThreads == 1) {
                        if (maxThreads == 1) {
                            echo "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç—ñ–≤ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ (–æ–¥–∏–Ω –∑–∞ –æ–¥–Ω–∏–º)"
                            for (int i = 0; i < testsToRun.size(); i++) {
                                def testName = testsToRun[i].trim()
                                stage("–ó–∞–ø—É—Å–∫ ${testName}") {
                                    echo "–ó–∞–ø—É—Å–∫–∞—î–º–æ —Ç–µ—Å—Ç: ${testName}"
                                    try {
                                        sh "RUN_ENV=jenkins mvn test -Dtest=${testName}"
                                        echo "‚úÖ –¢–µ—Å—Ç ${testName} –ø—Ä–æ–π—à–æ–≤ —É—Å–ø—ñ—à–Ω–æ"
                                    } catch (Exception e) {
                                        echo "‚ùå –¢–µ—Å—Ç ${testName} –∑–∞–≤–µ—Ä—à–∏–≤—Å—è –∑ –ø–æ–º–∏–ª–∫–æ—é: ${e.message}"
                                        currentBuild.result = 'UNSTABLE'
                                    }
                                }
                            }
                        } else {
                            // –ó–∞–ø—É—Å–∫ –≤—Å—ñ—Ö —Ç–µ—Å—Ç—ñ–≤ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ
                            def parallelStages = [:]
                            for (int i = 0; i < testsToRun.size(); i++) {
                                def testName = testsToRun[i].trim()
                                parallelStages["${testName}"] = { currentTest ->
                                    return {
                                        stage("–ó–∞–ø—É—Å–∫ ${currentTest}") {
                                            echo "–ó–∞–ø—É—Å–∫–∞—î–º–æ —Ç–µ—Å—Ç: ${currentTest}"
                                            try {
                                                sh "RUN_ENV=jenkins mvn test -Dtest=${currentTest}"
                                                echo "‚úÖ –¢–µ—Å—Ç ${currentTest} –ø—Ä–æ–π—à–æ–≤ —É—Å–ø—ñ—à–Ω–æ"
                                            } catch (Exception e) {
                                                echo "‚ùå –¢–µ—Å—Ç ${currentTest} –∑–∞–≤–µ—Ä—à–∏–≤—Å—è –∑ –ø–æ–º–∏–ª–∫–æ—é: ${e.message}"
                                                currentBuild.result = 'UNSTABLE'
                                            }
                                        }
                                    }
                                }(testName)
                            }
                            parallel parallelStages
                        }
                    } else {
                        // –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç—ñ–≤ –±–∞—Ç—á–∞–º–∏ –∑ –æ–±–º–µ–∂–µ–Ω–Ω—è–º –ø–æ—Ç–æ–∫—ñ–≤
                        echo "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç—ñ–≤ –±–∞—Ç—á–∞–º–∏ –ø–æ ${maxThreads} –ø–æ—Ç–æ–∫—ñ–≤"

                        for (int startIndex = 0; startIndex < testsToRun.size(); startIndex += maxThreads) {
                            def endIndex = Math.min(startIndex + maxThreads, testsToRun.size())
                            def currentBatch = testsToRun[startIndex..<endIndex]

                            echo "–ó–∞–ø—É—Å–∫ –±–∞—Ç—á—É ${(startIndex / maxThreads).toInteger() + 1}: ${currentBatch.join(', ')}"

                            def parallelStages = [:]
                            for (int i = 0; i < currentBatch.size(); i++) {
                                def testName = currentBatch[i].trim()
                                parallelStages["${testName}"] = { currentTest ->
                                    return {
                                        stage("–ó–∞–ø—É—Å–∫ ${currentTest}") {
                                            echo "–ó–∞–ø—É—Å–∫–∞—î–º–æ —Ç–µ—Å—Ç: ${currentTest}"
                                            try {
                                                sh "RUN_ENV=jenkins mvn test -Dtest=${currentTest}"
                                                echo "‚úÖ –¢–µ—Å—Ç ${currentTest} –ø—Ä–æ–π—à–æ–≤ —É—Å–ø—ñ—à–Ω–æ"
                                            } catch (Exception e) {
                                                echo "‚ùå –¢–µ—Å—Ç ${currentTest} –∑–∞–≤–µ—Ä—à–∏–≤—Å—è –∑ –ø–æ–º–∏–ª–∫–æ—é: ${e.message}"
                                                currentBuild.result = 'UNSTABLE'
                                            }
                                        }
                                    }
                                }(testName)
                            }

                            parallel parallelStages

                            // –ù–µ–≤–µ–ª–∏–∫–∞ –ø–∞—É–∑–∞ –º—ñ–∂ –±–∞—Ç—á–∞–º–∏ –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ
                            if (endIndex < testsToRun.size()) {
                                echo "–ü–∞—É–∑–∞ –º—ñ–∂ –±–∞—Ç—á–∞–º–∏..."
                                sleep(2)
                            }
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            allure([
                    reportBuildPolicy: 'ALWAYS',
                    results: [[path: 'target/allure-results']]
            ])
            echo "–¢–µ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
        }
    }
}